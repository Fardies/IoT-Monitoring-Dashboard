<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IoT Dashboard - Live Data</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background: #e8f5e9; /* light green theme */
  margin: 0;
  padding: 20px;
}
h1 { color: #1b5e20; }
h2 { margin-top: 40px; color: #2e7d32; }

button {
  background-color: #2e7d32;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  margin-bottom: 20px;
}
button:hover { background-color: #1b5e20; }

.cards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-top: 20px;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  text-align: center;
}

.card h3 { margin-bottom: 10px; color: #2e7d32; font-size: 16px; }
.value { font-size: 28px; font-weight: bold; color: #1b5e20; }

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin-top: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
table th, table td {
  padding: 12px;
  border-bottom: 1px solid #ddd;
  text-align: center;
}
table th {
  background: #2e7d32;
  color: white;
}
</style>
</head>
<body>

<h1>IoT Environmental Monitoring Dashboard</h1>
<button onclick="location.href='graph.html'">Go to Graphs</button>

<h2>Live Data</h2>
<div class="cards">
  <div class="card"><h3>Temperature (°C)</h3><div id="tempLive" class="value">--</div></div>
  <div class="card"><h3>Pressure (hPa)</h3><div id="presLive" class="value">--</div></div>
  <div class="card"><h3>Humidity (%)</h3><div id="humLive" class="value">--</div></div>
  <div class="card"><h3>Water Level (cm)</h3><div id="waterLive" class="value">--</div></div>
</div>

<h2>Daily Summary</h2>
<table id="dailyTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Water Level</th>
      <th>Temperature</th>
      <th>Humidity</th>
      <th>Pressure</th>
    </tr>
    <tr>
      <th></th>
      <th>Min / Max / Avg</th>
      <th>Min / Max / Avg</th>
      <th>Min / Max / Avg</th>
      <th>Min / Max / Avg</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// SAME SCRIPT AS BEFORE FOR FETCHING AND DAILY SUMMARY
const CHANNEL_ID = "3217594";
const READ_API_KEY = "5PEGJNOBO8DC3RRS";
const RESULTS = 1500;
const RAW_MIN = 0, RAW_MAX = 300;
const DISPLAY_MIN = 175, DISPLAY_MAX = 210;

function exponentialSmooth(data, alpha=0.1) {
  const smoothed = [];
  let last = data[0];
  smoothed.push(Number(last.toFixed(2)));
  for(let i=1; i<data.length; i++) {
    last = alpha*data[i] + (1-alpha)*last;
    smoothed.push(Number(last.toFixed(2)));
  }
  return smoothed;
}

function updateDashboard() {
  fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=${RESULTS}`)
  .then(res=>res.json())
  .then(data=>{
    const feeds = data.feeds.filter(f=>f.field1 && f.field2 && f.field3 && f.field4);
    const temp = feeds.map(f=>parseFloat(f.field1));
    const pres = feeds.map(f=>parseFloat(f.field2));
    const hum  = feeds.map(f=>parseFloat(f.field3));
    const water = feeds.map(f=>{
      const raw = parseFloat(f.field4);
      const norm = DISPLAY_MIN + ((raw-RAW_MIN)*(DISPLAY_MAX-DISPLAY_MIN))/(RAW_MAX-RAW_MIN);
      return Math.min(DISPLAY_MAX, Math.max(DISPLAY_MIN, Number(norm.toFixed(2))));
    });

    document.getElementById("tempLive").innerText  = temp.at(-1)+" °C";
    document.getElementById("presLive").innerText  = pres.at(-1)+" hPa";
    document.getElementById("humLive").innerText   = hum.at(-1)+" %";
    document.getElementById("waterLive").innerText = water.at(-1)+" cm";

    const dailyData = {};
    feeds.forEach((f,i)=>{
      const dateStr = new Date(f.created_at).toISOString().split("T")[0];
      if(!dailyData[dateStr]) dailyData[dateStr]={temp:[], pres:[], hum:[], water:[]};
      dailyData[dateStr].temp.push(temp[i]);
      dailyData[dateStr].pres.push(pres[i]);
      dailyData[dateStr].hum.push(hum[i]);
      dailyData[dateStr].water.push(water[i]);
    });

    const tbody = document.querySelector("#dailyTable tbody");
    tbody.innerHTML="";
    for(const [date, values] of Object.entries(dailyData)){
      function minMaxAvg(arr){ const min=Math.min(...arr); const max=Math.max(...arr); const avg=(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2); return `${min} / ${max} / ${avg}`; }
      const row=document.createElement("tr");
      row.innerHTML=`<td>${date}</td>
                     <td>${minMaxAvg(values.water)}</td>
                     <td>${minMaxAvg(values.temp)}</td>
                     <td>${minMaxAvg(values.hum)}</td>
                     <td>${minMaxAvg(values.pres)}</td>`;
      tbody.appendChild(row);
    }
  });
}

updateDashboard();
setInterval(updateDashboard,600000);
</script>

</body>
</html>
